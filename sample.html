<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Project Delivery Receipts</title>
<style>
  body {
    font-family: Calibri, sans-serif;
    padding: 30px;
    background: #f2f2f2;
    font-size: 13px;
  }

  .container {
    max-width: 950px;
    margin: auto;
    background: white;
    padding: 20px;
    border: 1px solid #ccc;
    box-shadow: 0 0 5px rgba(0,0,0,0.05);
  }

  .header {
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
  }

  button {
    padding: 6px 10px;
    margin: 3px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  button:hover { background-color: #0069d9; }
  .hidden { display: none; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #000;
    padding: 3px;
    font-size: 12px;
    text-align: center;
    word-wrap: break-word;
    white-space: normal;
  }

  th:nth-child(1), td:nth-child(1) { width: 8%; }
  th:nth-child(2), td:nth-child(2) { width: 8%; }
  th:nth-child(3), td:nth-child(3) { width: 30%; text-align: center; }
  th:nth-child(4), td:nth-child(4) { width: 5%; }
  th:nth-child(5), td:nth-child(5) { width: 18%; }

  input {
    border: none;
    border-bottom: 1px solid #999;
    background: transparent;
    font-size: 12px;
    outline: none;
    padding: 3px;
    margin: 2px 0;
    border-radius: 3px;
    width: 100%;
    text-align: center;
  }

  .info, .sign-boxes {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    font-size: 12px;
  }

  .sign-box { width: 45%; text-align: center; }
  .sign-box p { margin-top: 40px; border-top: 1px solid black; padding-top: 5px; font-size: 12px; }

  .record { padding: 8px; margin: 8px 0; background: #f9f9f9; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
  .no-print { text-align: center; }

  @media print {
    .no-print { display: none; }
    table { table-layout: auto; width: 100%; }
    th:nth-child(3), td:nth-child(3) { white-space: normal; word-wrap: break-word; }
  }

  .project-card {
    margin: 5px;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 4px;
    background-color: #fafafa;
    text-align: center;
    flex: 1 1 220px;
    font-size: 12px;
  }

  .project-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #slideModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #slideContent {
    background: white;
    padding: 15px;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
    border-radius: 6px;
    box-shadow: 0 0 10px black;
    font-size: 12px;
  }

  #slideContent h3 { text-align: center; margin-bottom: 10px; }
  #slideModal table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  #slideModal th, #slideModal td { border: 1px solid #ccc; padding: 4px; text-align: center; word-wrap: break-word; font-size: 12px; }

  .slide-nav { text-align: center; margin-top: 8px; }
  .pagination-controls { text-align: center; margin-top: 8px; font-size: 12px; }
  .logo { display: block; margin: 0 auto 8px auto; width: 100px; }

  #newProjectName, #searchBarProjects {
    width: 230px;
    padding: 5px 6px;
    font-size: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 4px 0;
    text-align: center;
  }

  #deliveryTitle {
    text-align: center;
    font-size: 16px !important;
    font-weight: bold;
    border: none;
    border-bottom: 1px dashed #ccc;
    width: 220px;
  }

  #receiptPrefix, #receiptNo {
    font-size: 12px;
    padding: 2px;
  }
</style>
</head>
<body>

<!-- HOME SECTION -->
<div class="container" id="homeSection">
  <input type="text" id="newProjectName" placeholder="‚ûï New Project Name" />
  <button onclick="addProject()">Add Project</button>
  <br><br>
  <input type="text" id="searchBarProjects" placeholder="üîç Search Project..." oninput="filterProjects()" />
  <div style="margin-top: 15px; text-align: center;">
    <button onclick="openDM()">‚ûï Add DM</button>
    <button onclick="openExtraExpenses()">‚ûï Add Extra Expenses</button>
  </div>

  <div class="header">üè† Project List</div>
  <div class="no-print" style="display: flex; flex-wrap: wrap;" id="projectButtons"></div>

  <div class="pagination-controls">
    <button onclick="prevPage()">‚¨Ö Previous</button>
    <span id="pageInfo">Page 1</span>
    <button onclick="nextPage()">Next ‚û°</button>
  </div>
</div>

<!-- FORM SECTION -->
<div class="container hidden" id="formSection">
  <div class="no-print" style="text-align:left; margin-bottom:10px;">
    <button style="background:#6c757d;" onclick="viewRecords(currentProject)">‚¨Ö Back</button>
  </div>
  <div class="header">GALFON'S BUILDERS & SUPPLY INC.</div>
  <div style="text-align:right; font-weight:bold;">
    <input type="text" id="receiptPrefix" style="width:60px;text-align:right;" value="DR-" onblur="savePrefix();autoSave()" /> 
    <input type="text" id="receiptNo" style="width:80px;" oninput="formatReceiptNo();autoSave();" />
  </div>
  <div style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:10px;">
    <input type="text" id="deliveryTitle" value="DELIVERY RECEIPT" oninput="autoSave()" />
  </div>
  <div class="info">
    <div><label>Project Name:</label> <input type="text" id="projectName" oninput="updateProjectNameInForm();autoSave()" /></div>
    <div><label>Date:</label> <input type="date" id="date" oninput="autoSave()" /></div>
  </div>
  <table id="itemsTable">
    <thead>
      <tr><th>Qty</th><th>Unit</th><th>Description</th><th>Unit Price</th><th>Amount</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="4" style="text-align:right;"><strong>Total</strong></td>
        <td><strong><input type="text" id="totalDisplay" value="‚Ç±0.00" style="width: 100px; text-align: right; font-weight: bold;" readonly /></strong></td>
      </tr>
    </tfoot>
  </table>

  <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
    <div>
      <label>Delivery Charge:</label> 
      <input type="number" id="deliveryCharge" value="0.00" step="0.01" oninput="updateTotal();autoSave();">
    </div>
    <div>
      <label>Vehicle:</label> 
      <input type="text" id="vehicle" oninput="autoSave();">
    </div>
    <div>
      <label>Driver/Helper:</label> 
      <input type="text" id="driverHelper" oninput="autoSave();">
    </div>
  </div>

  <div class="no-print">
    <button onclick="addRow()">‚ûï Add Item</button>
    <button onclick="saveReceipt(true)">üíæ Save</button>
    <button onclick="window.print()">üñ®Ô∏è Print</button>
  </div>
  <div class="sign-boxes">
    <div class="sign-box"><label>Prepared by:</label><p><input type="text" id="preparedBy" oninput="autoSave()" /></p></div>
    <div class="sign-box"><label>Received by:</label><p><input type="text" id="receivedBy" oninput="autoSave()" /></p></div>
  </div>
</div>

<!-- RECORDS SECTION -->
<div class="container hidden" id="recordSection">
  <div class="no-print" style="text-align:left; margin-bottom:10px;">
    <button style="background:#6c757d;" onclick="goHome()">‚¨Ö Back</button>
  </div>
  <div class="header">üìÅ Records for <span id="recordTitle"></span></div>
  <input type="text" id="searchBox" placeholder="üîç Search..." oninput="renderReceipts()" />
  <div id="receiptList"></div>
  <div class="no-print">
    <button onclick="goHome()">üè† Back to Projects</button>
    <button onclick="newEntry()">‚ûï New Entry</button>
    <button onclick="exportToCSV()">‚¨á Export CSV</button>
  </div>
</div>

<!-- SLIDE MODAL -->
<div id="slideModal" onclick="this.style.display='none'">
  <div id="slideContent" onclick="event.stopPropagation()">
    <h3>Receipt Details</h3>
    <div id="slideBody"></div>
    <div class="slide-nav">
      <button onclick="prevSlide()">‚¨Ö Previous</button>
      <button onclick="nextSlide()">Next ‚û°</button>
    </div>
    <div style="text-align:center;margin-top:10px;">
      <button onclick="editFromSlide()">‚úè Edit</button>
      <button onclick="printSlideContent()">Print</button>
      <button onclick="document.getElementById('slideModal').style.display='none'">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------- HELPER ---------- */
function formatPeso(val) {
  let num = parseFloat(val.toString().replace(/[^\d.-]/g, "")) || 0;
  return "‚Ç±" + num.toFixed(2);
}

/* VARIABLES */
let currentProject = "";
let currentReceiptNumber = 1;
let currentIndex = 0; 
let currentReceipts = [];
let currentPage = 1;
const projectsPerPage = 6;

/* ADD ROW */
function addRow(){
  const row=document.createElement("tr");
  row.innerHTML=`
    <td><input type="text" value="1" oninput="calc(this);autoSave();"></td>
    <td><input type="text" oninput="autoSave();"></td>
    <td><input type="text" style="width:98%; text-align:center;" oninput="autoSave();"></td>
    <td><input type="text" value="0.00" oninput="calc(this);autoSave();"></td>
    <td><input type="text" value="${formatPeso(0)}" oninput="updateTotal();autoSave();"></td>`;
  document.querySelector("#itemsTable tbody").appendChild(row);
  row.querySelector("td input").focus(); 
  updateTotal();
  autoSave();
}

/* CALC ITEM TOTAL */
function calc(el){
  const row = el.closest("tr");
  const qty = parseFloat(row.cells[0].querySelector("input").value) || 0;
  const price = parseFloat(row.cells[3].querySelector("input").value) || 0;
  row.cells[4].querySelector("input").value = formatPeso(qty * price);
  updateTotal();
}

/* UPDATE TOTAL */
function updateTotal() {
  let total = 0;
  document.querySelectorAll("#itemsTable tbody tr").forEach(row => {
    let amt = row.cells[4].querySelector("input").value.replace(/[^\d.-]/g, "");
    total += parseFloat(amt) || 0;
  });
  let delivery = parseFloat(document.getElementById("deliveryCharge").value) || 0;
  total += delivery;
  document.getElementById("totalDisplay").value = formatPeso(total);
}



/* ---------- PROJECT MANAGEMENT ---------- */
function addProject() {
  const name = document.getElementById("newProjectName").value.trim();
  if (!name) return alert("Enter project name");
  const key = name.toLowerCase().replace(/\s+/g, '_');
  const projects = JSON.parse(localStorage.getItem("projects") || "[]");
  if (!projects.includes(key)) {
    projects.push(key);
    localStorage.setItem("projects", JSON.stringify(projects));
  }
  document.getElementById("newProjectName").value = "";
  renderProjects();
}

function loadProjects() { renderProjects(); }

function renderProjects() {
  let projects = JSON.parse(localStorage.getItem("projects") || "[]");
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.endsWith("_receipts")) {
      const projectName = key.replace("_receipts", "");
      if (!projects.includes(projectName)) {
        projects.push(projectName);
      }
    }
  }
  localStorage.setItem("projects", JSON.stringify(projects));
  const search = document.getElementById("searchBarProjects").value.toLowerCase();
  const filtered = projects.filter(p => p.replace(/_/g, ' ').toLowerCase().includes(search));
  const startIndex = (currentPage - 1) * projectsPerPage;
  const endIndex = startIndex + projectsPerPage;
  const pageProjects = filtered.slice(startIndex, endIndex);
  document.getElementById("projectButtons").innerHTML = "";
  pageProjects.forEach(key => {
    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    createProjectCard(key, label);
  });
  document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${Math.max(1, Math.ceil(filtered.length / projectsPerPage))}`;
}

function prevPage() { if (currentPage > 1) { currentPage--; renderProjects(); } }
function nextPage() {
  const projects = JSON.parse(localStorage.getItem("projects") || "[]");
  const search = document.getElementById("searchBarProjects").value.toLowerCase();
  const filtered = projects.filter(p => p.replace(/_/g, ' ').toLowerCase().includes(search));
  if (currentPage < Math.ceil(filtered.length / projectsPerPage)) {
    currentPage++; renderProjects();
  }
}

function createProjectCard(key, label) {
  const receipts = JSON.parse(localStorage.getItem(`${key}_receipts`) || "[]");
  let total = receipts.reduce((sum, r) => {
    let t = (r.total ? r.total.toString().replace(/[^\d.-]/g, '') : "0");
    return sum + parseFloat(t || "0");
  }, 0);

  const div = document.createElement("div");
  div.className = "project-card";
  div.innerHTML = `
    <div class="project-header">
      <input type="text" value="${label}" style="font-weight:bold;font-size:16px;text-align:center;width:80%;border:none;border-bottom:1px solid #ccc;" onblur="renameProject('${key}', this.value)">
      <button style="background:red;" title="Delete Project" onclick="deleteProject('${key}')">üóë</button>
    </div>
    <div><small>üßæ ‚Ç±${total.toFixed(2)}</small></div>
    <button onclick="openProject('${key}')">‚ûï New Entry</button>
    <button onclick="viewRecords('${key}')">üìÅ View Records</button>`;
  document.getElementById("projectButtons").appendChild(div);
}


function deleteProject(key) {
  if (!confirm("Are you sure you want to delete this project and all its receipts?")) return;
  localStorage.removeItem(`${key}_receipts`);
  localStorage.removeItem(`${key}_lastReceipt`);
  localStorage.removeItem(`${key}_prefix`);
  localStorage.removeItem(`${key}_draft`);
  const projects = JSON.parse(localStorage.getItem("projects") || "[]");
  const index = projects.indexOf(key);
  if (index !== -1) {
    projects.splice(index, 1);
    localStorage.setItem("projects", JSON.stringify(projects));
  }
  renderProjects();
}

function renameProject(oldKey,newName){
  const newKey=newName.toLowerCase().replace(/\s+/g,'_');
  if(newKey===oldKey)return;
  const projects=JSON.parse(localStorage.getItem("projects")||"[]");
  const idx=projects.indexOf(oldKey);
  if(idx!==-1){
    const receipts = JSON.parse(localStorage.getItem(`${oldKey}_receipts`) || "[]");
    receipts.forEach(r => { r.project = newName; });
    localStorage.setItem(`${newKey}_receipts`, JSON.stringify(receipts));
    localStorage.removeItem(`${oldKey}_receipts`);
    const prefix = localStorage.getItem(`${oldKey}_prefix`);
    if (prefix) {
      localStorage.setItem(`${newKey}_prefix`, prefix);
      localStorage.removeItem(`${oldKey}_prefix`);
    }
    const lastReceipt = localStorage.getItem(`${oldKey}_lastReceipt`);
    if (lastReceipt) {
      localStorage.setItem(`${newKey}_lastReceipt`, lastReceipt);
      localStorage.removeItem(`${oldKey}_lastReceipt`);
    }
    projects[idx]=newKey;
    localStorage.setItem("projects",JSON.stringify(projects));
    if (currentProject === oldKey) currentProject = newKey;
    renderProjects();
  }
}

function filterProjects(){ currentPage = 1; renderProjects(); }

/* ---------- RECEIPT FORM ---------- */
function openProject(key){
  currentProject=key;
  document.getElementById("projectName").value=key.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
  document.getElementById("date").valueAsDate=new Date();
  currentReceiptNumber=parseInt(localStorage.getItem(`${key}_lastReceipt`)||"0")+1;
  loadPrefix();
  document.getElementById("receiptNo").value=currentReceiptNumber.toString().padStart(5,'0');
  document.getElementById("homeSection").classList.add("hidden");
  document.getElementById("formSection").classList.remove("hidden");
  clearForm(); addRow(); loadDraft(); autoSave();
}

function updateProjectNameInForm() {
  if (!currentProject) return;
  const newName = document.getElementById("projectName").value.trim();
  if (!newName) return;
  renameProject(currentProject, newName);
}

function clearForm(){
  document.querySelector("#itemsTable tbody").innerHTML="";
  document.getElementById("deliveryCharge").value="0.00";
  document.getElementById("vehicle").value="";
  document.getElementById("driverHelper").value="";
  document.getElementById("preparedBy").value="";
  document.getElementById("receivedBy").value="";
  document.getElementById("deliveryTitle").value="DELIVERY RECEIPT";
  updateTotal();
}

function saveReceipt(showAlert=false){
  if(!currentProject)return;
  const rows=[];
  document.querySelectorAll("#itemsTable tbody tr").forEach(tr=>{
    const cells=tr.querySelectorAll("input");
    if (cells[0].value.trim()!=="" || cells[2].value.trim()!=="") {
      rows.push({
        qty:cells[0].value,
        unit:cells[1].value,
        desc:cells[2].value,
        price:cells[3].value,
        amount:cells[4].value
      });
    }
  });

  if (rows.length === 0) {
    alert("Please add at least one item before saving.");
    return;
  }

  const receipts=JSON.parse(localStorage.getItem(`${currentProject}_receipts`)||"[]");
  let data={
    receiptNo:document.getElementById("receiptPrefix").value+document.getElementById("receiptNo").value,
    project:document.getElementById("projectName").value,
    date:document.getElementById("date").value,
    items:rows,
    total:document.getElementById("totalDisplay").value,
    deliveryCharge:document.getElementById("deliveryCharge").value,
    vehicle:document.getElementById("vehicle").value,
    driverHelper:document.getElementById("driverHelper").value,
    preparedBy:document.getElementById("preparedBy").value,
    receivedBy:document.getElementById("receivedBy").value,
    deliveryTitle: document.getElementById("deliveryTitle").value
  };
  receipts.push(data);
  localStorage.setItem(`${currentProject}_receipts`,JSON.stringify(receipts));
  localStorage.setItem(`${currentProject}_lastReceipt`,currentReceiptNumber);
  localStorage.removeItem(`${currentProject}_draft`);
  if (showAlert) alert("Saved!");
  viewRecords(currentProject);
}

function autoSave(){
  if(!currentProject)return;
  const rows=[];
  document.querySelectorAll("#itemsTable tbody tr").forEach(tr=>{
    const cells=tr.querySelectorAll("input");
    rows.push({
      qty:cells[0].value,
      unit:cells[1].value,
      desc:cells[2].value,
      price:cells[3].value,
      amount:cells[4].value
    });
  });
  const draft={
    receiptNo:document.getElementById("receiptNo").value,
    project:document.getElementById("projectName").value,
    date:document.getElementById("date").value,
    items:rows,
    total:document.getElementById("totalDisplay").value,
    deliveryCharge:document.getElementById("deliveryCharge").value,
    vehicle:document.getElementById("vehicle").value,
    driverHelper:document.getElementById("driverHelper").value,
    preparedBy:document.getElementById("preparedBy").value,
    receivedBy:document.getElementById("receivedBy").value,
    prefix:document.getElementById("receiptPrefix").value,
    deliveryTitle: document.getElementById("deliveryTitle").value
  };
  localStorage.setItem(`${currentProject}_draft`, JSON.stringify(draft));
}

function loadDraft(){
  if(!currentProject)return;
  const draft=JSON.parse(localStorage.getItem(`${currentProject}_draft`)||"null");
  if(!draft)return;
  document.getElementById("receiptNo").value=draft.receiptNo;
  document.getElementById("projectName").value=draft.project;
  document.getElementById("date").value=draft.date;
  document.querySelector("#itemsTable tbody").innerHTML="";
  draft.items.forEach(item=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td><input type="text" value="${item.qty}" oninput="calc(this);autoSave();"></td>
      <td><input type="text" value="${item.unit}" oninput="autoSave();"></td>
      <td><input type="text" value="${item.desc}" style="width:98%;" oninput="autoSave();"></td>
      <td><input type="text" value="${item.price}" oninput="calc(this);autoSave();"></td>
      <td><input type="text" value="${item.amount}" oninput="updateTotal();autoSave();"></td>`;
    document.querySelector("#itemsTable tbody").appendChild(row);
  });
  document.getElementById("totalDisplay").value=draft.total;
  document.getElementById("deliveryCharge").value=draft.deliveryCharge;
  document.getElementById("vehicle").value=draft.vehicle;
  document.getElementById("driverHelper").value=draft.driverHelper;
  document.getElementById("preparedBy").value=draft.preparedBy;
  document.getElementById("receivedBy").value=draft.receivedBy;
  document.getElementById("receiptPrefix").value=draft.prefix||"DR-";
  document.getElementById("deliveryTitle").value = draft.deliveryTitle || "DELIVERY RECEIPT";
}

function formatReceiptNo(){
  let val=document.getElementById("receiptNo").value.replace(/\D/g,'');
  document.getElementById("receiptNo").value=val.padStart(5,'0');
  autoSave();
}

function loadPrefix(){
  const prefix=localStorage.getItem(`${currentProject}_prefix`)||"DR-";
  document.getElementById("receiptPrefix").value=prefix;
}

function savePrefix(){
  if(!currentProject)return;
  const prefix=document.getElementById("receiptPrefix").value;
  localStorage.setItem(`${currentProject}_prefix`,prefix);
}

/* ---------- RECORDS ---------- */
function viewRecords(key){
  currentProject=key;
  document.getElementById("recordTitle").textContent=key.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
  document.getElementById("homeSection").classList.add("hidden");
  document.getElementById("formSection").classList.add("hidden");
  document.getElementById("recordSection").classList.remove("hidden");
  renderReceipts();
}

function renderReceipts(){
  const container=document.getElementById("receiptList");
  container.innerHTML="";
  const search=document.getElementById("searchBox").value.toLowerCase();
  const receipts=JSON.parse(localStorage.getItem(`${currentProject}_receipts`)||"[]");
  currentReceipts = receipts;
  receipts.forEach((r,i)=>{
    if (r.receiptNo.toLowerCase().includes(search) || (r.date && r.date.includes(search))) {
      const div=document.createElement("div");
      div.className="record";
      div.innerHTML=`<strong>${r.receiptNo}</strong> - ${r.date} - ‚Ç±${r.total}
      <button onclick="showSlide(${i})">View Info</button>
      <button onclick="editReceipt(${i})">Edit</button>
      <button onclick="deleteReceipt(${i})">Delete</button>`;
      container.appendChild(div);
    }
  });
  if (container.innerHTML === "") {
    container.innerHTML = "<p style='text-align:center;'>No records found.</p>";
  }
}

function deleteReceipt(index){
  if (!confirm("Delete this receipt?")) return;
  const receipts=JSON.parse(localStorage.getItem(`${currentProject}_receipts`)||"[]");
  receipts.splice(index,1);
  localStorage.setItem(`${currentProject}_receipts`,JSON.stringify(receipts));
  renderReceipts();
}

function editReceipt(index){
  const receipts=JSON.parse(localStorage.getItem(`${currentProject}_receipts`)||"[]");
  const r=receipts[index];
  openProject(currentProject);
  document.getElementById("receiptNo").value=r.receiptNo.replace(document.getElementById("receiptPrefix").value,"");
  document.getElementById("projectName").value=r.project;
  document.getElementById("date").value=r.date;
  document.querySelector("#itemsTable tbody").innerHTML="";
  r.items.forEach(item=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td><input type="text" value="${item.qty}" oninput="calc(this);autoSave();"></td>
      <td><input type="text" value="${item.unit}" oninput="autoSave();"></td>
      <td><input type="text" value="${item.desc}" style="width:98%;" oninput="autoSave();"></td>
      <td><input type="text" value="${item.price}" oninput="calc(this);autoSave();"></td>
      <td><input type="text" value="${item.amount}" oninput="updateTotal();autoSave();"></td>`;
    document.querySelector("#itemsTable tbody").appendChild(row);
  });
  document.getElementById("totalDisplay").value=r.total;
  document.getElementById("deliveryCharge").value=r.deliveryCharge||"0.00";
  document.getElementById("vehicle").value=r.vehicle||"";
  document.getElementById("driverHelper").value=r.driverHelper||"";
  document.getElementById("preparedBy").value=r.preparedBy||"";
  document.getElementById("receivedBy").value=r.receivedBy||"";
  document.getElementById("deliveryTitle").value = r.deliveryTitle || "DELIVERY RECEIPT";
}

function newEntry(){ openProject(currentProject); }

function goHome(){
  document.getElementById("homeSection").classList.remove("hidden");
  document.getElementById("formSection").classList.add("hidden");
  document.getElementById("recordSection").classList.add("hidden");
  renderProjects();
}

/* ---------- SLIDE VIEW ---------- */
function showSlide(index){
  currentIndex = index;
  displaySlide();
  document.getElementById("slideModal").style.display = "flex";
}

function displaySlide(){
  const r = currentReceipts[currentIndex];
  let total = r.total.replace(/^‚Ç±/, '‚Ç±');
  let delivery = r.deliveryCharge.toString().replace(/^‚Ç±/, '‚Ç±');

  let html = `<p><strong>${r.receiptNo}</strong> | ${r.date}</p>`;
  html += `<p><strong>${r.deliveryTitle || "DELIVERY RECEIPT"}</strong></p>`;
  html += `<table><thead><tr><th>Qty</th><th>Unit</th><th>Description</th><th>Unit Price</th><th>Amount</th></tr></thead><tbody>`;
  r.items.forEach(item=>{
    let price = item.price.replace(/^‚Ç±/, '‚Ç±');
    let amount = item.amount.replace(/^‚Ç±/, '‚Ç±');
    html += `<tr><td>${item.qty}</td><td>${item.unit}</td><td>${item.desc}</td><td>${price}</td><td>${amount}</td></tr>`;
  });
  html += `</tbody></table>`;
  html += `<p><strong>Total:</strong> ${total}</p>`;
  html += `<p><strong>Delivery Charge:</strong> ${delivery}</p>`;
  html += `<p><strong>Vehicle:</strong> ${r.vehicle} | <strong>Driver/Helper:</strong> ${r.driverHelper}</p>`;
  html += `<p><strong>Prepared by:</strong> ${r.preparedBy} | <strong>Received by:</strong> ${r.receivedBy}</p>`;
  document.getElementById("slideBody").innerHTML = html;
}


function prevSlide(){
  if(currentIndex>0){ currentIndex--; displaySlide(); }
}
function nextSlide(){
  if(currentIndex<currentReceipts.length-1){ currentIndex++; displaySlide(); }
}
function editFromSlide(){
  editReceipt(currentIndex);
  document.getElementById("slideModal").style.display="none";
}
function printSlideContent() {
  const printWindow = window.open("", "_blank");
  printWindow.document.write("<html><head><title>Print</title>");
  printWindow.document.write("<style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:4px;text-align:center;font-size:12px;}</style>");
  printWindow.document.write("</head><body>");
  printWindow.document.write(document.getElementById("slideBody").innerHTML);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.print();
}


/* ---------- EXPORT ---------- */
function exportToCSV(){
  const receipts=JSON.parse(localStorage.getItem(`${currentProject}_receipts`)||"[]");
  if(receipts.length==0){alert("No data");return;}
  let csv="Receipt No,Date,Project,Item Qty,Unit,Description,Unit Price,Amount,Total,Delivery Charge,Vehicle,Driver/Helper,Prepared By,Received By\n";
  receipts.forEach(r=>{
    r.items.forEach(item=>{
      csv+=`"${r.receiptNo}","${r.date}","${r.project}","${item.qty}","${item.unit}","${item.desc}","${item.price}","${item.amount}","${r.total}","${r.deliveryCharge}","${r.vehicle}","${r.driverHelper}","${r.preparedBy}","${r.receivedBy}"\n`;
    });
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${currentProject}_receipts.csv`;
  a.click();
}

/* ---------- MISC ---------- */
function openDM(){ alert("DM feature coming soon."); }
function openExtraExpenses(){ alert("Extra Expenses feature coming soon."); }

/* ---------- INIT ---------- */
window.onload=()=>{ loadProjects(); }
</script>
</body>
</html>
